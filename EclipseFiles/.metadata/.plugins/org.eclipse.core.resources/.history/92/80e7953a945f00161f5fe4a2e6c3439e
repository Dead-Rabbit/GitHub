package Imp;
import java.util.ArrayList;
import java.util.List;
import java.sql.*;

import net.sf.json.JSONObject;
import Dao.*;
import Interf.itemInterf;
import Interf.itemInterf.*;
import JDBCHelpr.JdbcHelper;
import Imp.*;

public class itemImp implements itemInterf {
	JdbcHelper helper = null;
	Connection conn = null;
	public itemImp(){
		helper = new JdbcHelper();
		conn = helper.getConn();
	}
	@Override
	public List<itemDao> returnAll() {
		// TODO Auto-generated method stub
		String sqlString = "select * from items";
		List<itemDao> list = new ArrayList<itemDao>();
		try{
			ResultSet res = null;
			Statement sta = conn.createStatement();
			res = sta.executeQuery(sqlString);
			while(res.next()){
				itemDao dao = new itemDao();
				dao.setId(res.getInt("id"));
				dao.setState(res.getString("state"));
				dao.setTime(res.getString("time"));
				dao.setTitle(res.getString("title"));
				list.add(dao);
			}
			
		}catch(Exception e){
			e.printStackTrace();
		}
		return list;
	}
	public itemDao retById(int id){
		itemDao dao = new itemDao();
		String sqlString = "select * from items where id = ?";
		try{
			ResultSet res = null;
			PreparedStatement psta = conn.prepareStatement(sqlString);
			psta.setInt(1, id);
			res = psta.executeQuery();
			while(res.next()){
				dao.setId(res.getInt("id"));
				dao.setState(res.getString("state"));
				dao.setTime(res.getString("time"));
				dao.setTitle(res.getString("title"));
			}
		}
		catch(Exception e){
			e.printStackTrace();
		}
		return dao;
	}
	@Override
	public boolean insertItem(JSONObject json) {
		// TODO Auto-generated method stub
		boolean ifSucc = false;
		quesImp quesimp = new quesImp();
		String sqlString = "insert into items(id,title,time,state) values (?,?,?,'未发布')";
		try{
			PreparedStatement psta = conn.prepareStatement(sqlString);
			psta.setInt(1,getNewId());
			psta.setString(2, json.getString("title"));
			psta.setString(3, json.getString("time"));
			psta.setString(4, json.getString("state"));
			psta.executeUpdate();
			//进行逐条插入 （问题信息）
			for(JSONObject obj : json.getJSONArray("questionbank").)
			quesimp.insertQues(json);
			ifSucc = true;
		}catch (Exception e){
			e.printStackTrace();
		}
		return ifSucc;
	}
/**** 辅助方法 *****/
	private int getNewId(){
		int id = 0;
		String sqlString = "select * from items order by id desc";
		try{
			ResultSet res = null;
			Statement sta = conn.createStatement();
			res = sta.executeQuery(sqlString);
			while(res.next()){
				id = res.getInt("id");
				break;
			}
			id++;
		}catch (Exception e){
			e.printStackTrace();
		}
		return id;
	}
	public static void main(String[] args) {
//		itemImp imp = new itemImp();
		
//		for(itemDao dao : imp.returnAll()){
//			System.out.println(dao.getState());
//		}
//		System.out.println(imp.getNewId());
	}
}
